{% extends "Layouts/base.html" %}
{% block container %}
<div class="container">
        <div class="p-5">
            <h4 class="fs-3">Prix totale :</h4>
            <p class="total"></p>

        </div>
        <br>
        <div class="goods-page">
            <div class="goods-data clearfix">
                <div class="table-wrapper-responsive">
                    <table summary="Shopping cart">
                        <thead >
                            <tr>
                                <th class="goos-page-image">Nom du Produit</th>
                                <th class="goos-page-image">Quantité</th>
                                <th class="goods-page-price">Prix</th>
                                <th class="goods-page-price">Sous-total</th>
                                <th class="goods-page-price">Action</th>
                            </tr>
                        </thead>
                        <tbody id="item-list">
                            <!-- Les produits seront ajoutés ici par JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>                                                            
        <div class="row mt-3 w-100" style="margin-bottom: 5%;">
          <a href="{% url 'stripe' %}" class="btn btn-warning">Stripe</a>
        </div>
    </div>


{% endblock container %}

{% block js %}

<script type="text/javascript">
    console.log('juste pour tester');

    if (localStorage.getItem('panier') == null) {
        var panier = {};
    } else {
        var panier = JSON.parse(localStorage.getItem('panier'));
    }

    function updateProductList() {
        let total = 0;
        document.getElementById('item-list').innerHTML = ''; // Vider la liste existante

        for (let item_id in panier) {
            let product = panier[item_id];
            let nom = product.name;
            let quantite = product.quantity;
            let prix = product.price;
            let sousTotal = quantite * prix;
            total += sousTotal;

            // Créer la ligne pour chaque produit avec boutons pour modifier la quantité
            let rowString = `
                <tr id="product-${item_id}">
                    <td>${nom}</td>
                    <td>
                        <button class="btn btn-light" onclick="changeQuantity('${item_id}', 'increase')">+</button>
                        <span id="quantity-${item_id}">${quantite}</span>
                        <button class="btn btn-light" onclick="changeQuantity('${item_id}', 'decrease')">-</button>
                    </td>
                    <td>${prix.toFixed(2)}€</td>
                    <td>${sousTotal.toFixed(2)}€</td>
                    <td><button class="btn btn-close" onclick="removeProduct('${item_id}')">X</button></td>
                </tr>
            `;
            document.getElementById('item-list').insertAdjacentHTML('beforeend', rowString);
        }

        // Mettre à jour le prix total dans la page
        document.querySelector('.total').textContent = total + ' €';

        // Enregistrer le prix total dans sessionStorage
        sessionStorage.setItem('prix', total);
    }

    // Fonction pour changer la quantité d'un produit
    function changeQuantity(itemId, action) {
        if (action === 'increase') {
            panier[itemId].quantity += 1;
        } else if (action === 'decrease' && panier[itemId].quantity > 1) {
            panier[itemId].quantity -= 1;
        }

        localStorage.setItem('panier', JSON.stringify(panier));
        updateProductList();
    }

    // Fonction pour supprimer un produit du panier
    function removeProduct(itemId) {
        delete panier[itemId];
        localStorage.setItem('panier', JSON.stringify(panier));
        updateProductList();
    }

    // Mettre à jour la liste des produits lors du chargement initial
    updateProductList();
    
</script>
{% endblock %}